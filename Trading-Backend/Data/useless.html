<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordinal Marketplace PSBT Tester</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #0f0f23; color: #fff; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; padding: 20px; background: #1a1a2e; border-radius: 10px; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab { padding: 12px 24px; cursor: pointer; border: 1px solid transparent; margin-right: 5px; background: #252536; }
        .tab.active { border-color: #4CAF50; border-bottom-color: #0f0f23; background: #2d2d44; border-radius: 5px 5px 0 0; }
        .tab-content { display: none; padding: 25px; background: #1a1a2e; border-radius: 0 5px 5px 5px; margin-bottom: 20px; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #ccc; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 12px; background: #2d2d44; border: 1px solid #444; border-radius: 6px; color: #fff; font-size: 14px; }
        textarea { height: 150px; font-family: monospace; resize: vertical; }
        button { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px; font-weight: bold; }
        button:hover { background: #45a049; transform: translateY(-1px); }
        button:disabled { background: #666; cursor: not-allowed; transform: none; }
        button.secondary { background: #2196F3; }
        button.danger { background: #f44336; }
        button.warning { background: #ff9800; }
        .result { margin-top: 20px; padding: 20px; border-radius: 6px; white-space: pre-wrap; font-family: monospace; font-size: 13px; line-height: 1.4; }
        .success { border-left: 4px solid #4CAF50; background: #1b5e20; }
        .error { border-left: 4px solid #f44336; background: #b71c1c; }
        .info { border-left: 4px solid #2196F3; background: #0d47a1; }
        .warning { border-left: 4px solid #ff9800; background: #e65100; }
        .status { padding: 15px; margin: 15px 0; border-radius: 6px; font-weight: bold; }
        .connected { background: #1b5e20; color: #a5d6a7; }
        .disconnected { background: #b71c1c; color: #ffcdd2; }
        .step { background: #252536; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4CAF50; }
        .step-number { background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .endpoint-card { background: #252536; padding: 15px; border-radius: 6px; border: 1px solid #444; }
        .endpoint-card h4 { color: #4CAF50; margin-bottom: 10px; }
        .debug-section { background: #2d2d44; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .api-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        .api-status.healthy { background: #4CAF50; }
        .api-status.unhealthy { background: #f44336; }
        .method-buttons { display: flex; gap: 10px; margin: 10px 0; }
        .psbt-method { background: #333; padding: 10px; border-radius: 4px; margin: 5px 0; }
        .wallet-info { background: #252536; padding: 15px; border-radius: 6px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Ordinal Marketplace PSBT Tester</h1>
            <p>Complete testing interface for all PSBT endpoints using Unisat Wallet</p>
            <div style="margin-top: 10px;">
                <span>API Status: </span>
                <span id="apiStatus" class="api-status unhealthy">Checking...</span>
            </div>
        </div>

        <!-- Protocol Warning -->
        <div class="warning" id="protocolWarning">
            <strong>‚ö†Ô∏è Important:</strong> This page must be served via HTTP (not file://) for Unisat Wallet to work!
        </div>

        <!-- Network Warning -->
        <div class="warning" id="networkWarning" style="display: none;">
            <strong>‚ö†Ô∏è Network Mismatch:</strong> Your wallet is on <span id="currentNetwork">mainnet</span> but this test requires <strong>testnet</strong>.
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('wallet')">üîó Wallet</div>
            <div class="tab" onclick="switchTab('seller')">üè∑Ô∏è Seller Flow</div>
            <div class="tab" onclick="switchTab('buyer')">üõí Buyer Flow</div>
            <div class="tab" onclick="switchTab('utilities')">üîß Utilities</div>
            <div class="tab" onclick="switchTab('debug')">üêõ Debug</div>
        </div>

        <!-- Wallet Tab -->
        <div id="wallet" class="tab-content active">
            <h2>üîó Wallet Connection & Setup</h2>
            
            <div class="step">
                <h3><span class="step-number">1</span> Check Environment</h3>
                <button onclick="checkEnvironment()" class="secondary">Check Environment</button>
                <button onclick="startLocalServer()" class="secondary">Start Local Server</button>
                <div id="environmentResult" class="result"></div>
            </div>

            <div class="step">
                <h3><span class="step-number">2</span> Connect Unisat Wallet</h3>
                <div id="walletStatus" class="status disconnected">
                    üîç Checking Unisat Wallet availability...
                </div>
                <button onclick="connectWallet()" id="connectBtn" disabled>Connect Unisat Wallet</button>
                <button onclick="getWalletInfo()" id="infoBtn" disabled class="secondary">Get Wallet Info</button>
                
                <div id="walletDetails" class="wallet-info" style="display: none;">
                    <h4>Wallet Details</h4>
                    <div id="walletInfo"></div>
                </div>
            </div>

            <div class="step">
                <h3><span class="step-number">3</span> Test Backend Connection</h3>
                <div class="form-group">
                    <label for="backendUrl">Backend API URL:</label>
                    <input type="text" id="backendUrl" value="http://localhost:5000/api">
                </div>
                <button onclick="testBackendConnection()" class="secondary">Test Backend Connection</button>
                <div id="backendResult" class="result"></div>
            </div>
        </div>

        <!-- Seller Flow Tab -->
        <div id="seller" class="tab-content">
            <h2>üè∑Ô∏è Seller Flow - List Your Ordinal</h2>
            
            <div class="step">
                <h3><span class="step-number">1</span> Generate Seller PSBT</h3>
                <div class="form-group">
                    <label for="sellerData">Seller PSBT Data (JSON):</label>
                    <textarea id="sellerData">
{
    "inscription_id": "7b84375b69eb3a8f2a914e890237f35642daf223aa20b250866b33bfd4dca81fi0",
    "inscription_output": "7b84375b69eb3a8f2a914e890237f35642daf223aa20b250866b33bfd4dca81f:0",
    "price_sats": 5000,
    "seller_address": "tb1qcthlw722s2tt02ftc4jl78cewq2hglgg4a6php",
    "payment_address": "tb1qcthlw722s2tt02ftc4jl78cewq2hglgg4a6php",
    "network": "testnet"
}</textarea>
                </div>
                
                <div class="method-buttons">
                    <button onclick="generateSellerPSBT('compat')" class="compat-btn">Generate Compatible PSBT</button>
                    <button onclick="generateSellerPSBT('simple')" class="simple-btn">Generate Simple PSBT</button>
                </div>
                
                <div class="form-group">
                    <label for="unsignedPSBT">Generated Unsigned PSBT:</label>
                    <textarea id="unsignedPSBT" placeholder="Unsigned PSBT will appear here..."></textarea>
                </div>
                
                <div id="sellerGenerateResult" class="result"></div>
            </div>

            <div class="step">
                <h3><span class="step-number">2</span> Sign PSBT</h3>
                <button onclick="signPSBT()" id="signBtn" disabled>Sign PSBT</button>
                <button onclick="signPSBTSafe()" id="signSafeBtn" disabled class="secondary">Sign PSBT (Safe Mode)</button>
                <button onclick="analyzePSBT()" class="secondary">Analyze PSBT</button>
                
                <div class="form-group">
                    <label for="signedPSBT">Signed PSBT:</label>
                    <textarea id="signedPSBT" placeholder="Signed PSBT will appear here..."></textarea>
                </div>
                
                <div id="sellerSignResult" class="result"></div>
            </div>

            <div class="step">
                <h3><span class="step-number">3</span> Create Listing</h3>
                <button onclick="createListing()" class="compat-btn">Create Listing</button>
                <button onclick="verifySignedPSBT()" class="secondary">Verify Signed PSBT</button>
                <div id="sellerListingResult" class="result"></div>
            </div>
        </div>

        <!-- Buyer Flow Tab -->
        <div id="buyer" class="tab-content">
            <h2>üõí Buyer Flow - Purchase Ordinal</h2>
            
            <div class="step">
                <h3><span class="step-number">1</span> Create Dummy UTXO (First Time)</h3>
                <div class="form-group">
                    <label for="dummyUtxoData">Dummy UTXO Data (JSON):</label>
                    <textarea id="dummyUtxoData">
{
    "payer_address": "tb1qcthlw722s2tt02ftc4jl78cewq2hglgg4a6php",
    "number_of_dummy_utxos": 2,
    "network": "testnet",
    "fee_level": "hourFee"
}</textarea>
                </div>
                <button onclick="generateDummyUTXO()" class="secondary">Generate Dummy UTXO PSBT</button>
                <div id="dummyUtxoResult" class="result"></div>
            </div>

            <div class="step">
                <h3><span class="step-number">2</span> Generate Buyer PSBT</h3>
                <div class="form-group">
                    <label for="buyerData">Buyer PSBT Data (JSON):</label>
                    <textarea id="buyerData">
{
    "listing_id": "YOUR_LISTING_ID_HERE",
    "buyer_payment_address": "tb1qcthlw722s2tt02ftc4jl78cewq2hglgg4a6php",
    "buyer_receive_address": "tb1qcthlw722s2tt02ftc4jl78cewq2hglgg4a6php",
    "fee_level": "hourFee",
    "network": "testnet"
}</textarea>
                </div>
                <button onclick="generateBuyerPSBT()" class="compat-btn">Generate Buyer PSBT</button>
                <div id="buyerGenerateResult" class="result"></div>
            </div>

            <div class="step">
                <h3><span class="step-number">3</span> Sign & Broadcast</h3>
                <button onclick="signBuyerPSBT()" class="secondary">Sign Buyer PSBT</button>
                <button onclick="broadcastTransaction()" class="compat-btn">Broadcast Transaction</button>
                <div id="buyerBroadcastResult" class="result"></div>
            </div>
        </div>

        <!-- Utilities Tab -->
        <div id="utilities" class="tab-content">
            <h2>üîß Utility Endpoints</h2>
            
            <div class="grid">
                <div class="endpoint-card">
                    <h4>üîç Verify Ownership</h4>
                    <div class="form-group">
                        <label>Inscription ID:</label>
                        <input type="text" id="verifyInscriptionId" placeholder="abc123i0">
                    </div>
                    <div class="form-group">
                        <label>Address:</label>
                        <input type="text" id="verifyAddress" placeholder="tb1p...">
                    </div>
                    <button onclick="verifyOwnership()" class="secondary">Verify Ownership</button>
                </div>

                <div class="endpoint-card">
                    <h4>üìã Decode PSBT</h4>
                    <div class="form-group">
                        <label>PSBT/Transaction Data:</label>
                        <textarea id="decodeData" placeholder="Paste PSBT or transaction data"></textarea>
                    </div>
                    <button onclick="decodePSBTData()" class="secondary">Decode Data</button>
                </div>

                <div class="endpoint-card">
                    <h4>‚úÖ Validate PSBT</h4>
                    <div class="form-group">
                        <label>PSBT Base64:</label>
                        <textarea id="validatePSBTData" placeholder="Paste PSBT base64"></textarea>
                    </div>
                    <button onclick="validatePSBT()" class="secondary">Validate PSBT</button>
                </div>

                <div class="endpoint-card">
                    <h4>üéØ Analyze Address</h4>
                    <div class="form-group">
                        <label>Bitcoin Address:</label>
                        <input type="text" id="analyzeAddress" placeholder="tb1p...">
                    </div>
                    <button onclick="analyzeAddress()" class="secondary">Analyze Address</button>
                </div>
            </div>
            
            <div id="utilitiesResult" class="result"></div>
        </div>

        <!-- Debug Tab -->
        <div id="debug" class="tab-content">
            <h2>üêõ Debug & Diagnostics</h2>
            
            <div class="debug-section">
                <button onclick="runFullDiagnostics()" class="warning">Run Full Diagnostics</button>
                <button onclick="testAllEndpoints()" class="warning">Test All Endpoints</button>
                <button onclick="showCommonFixes()" class="secondary">Show Common Fixes</button>
                <button onclick="clearAll()" class="danger">Clear All</button>
                <button onclick="loadSampleData()" class="secondary">Load Sample Data</button>
            </div>

            <div class="step">
                <h3>Endpoint Testing</h3>
                <div class="method-buttons">
                    <button onclick="testEndpoint('health')" class="secondary">Test /health</button>
                    <button onclick="testEndpoint('generate-seller')" class="secondary">Test /generate-seller</button>
                    <button onclick="testEndpoint('generate-buyer')" class="secondary">Test /generate-buyer</button>
                    <button onclick="testEndpoint('verify-ownership')" class="secondary">Test /verify-ownership</button>
                    <button onclick="testEndpoint('decode')" class="secondary">Test /decode</button>
                </div>
            </div>

            <div id="debugResult" class="result"></div>
        </div>
    </div>

    <script>
        // Global variables
        let isWalletConnected = false;
        let currentWalletAddress = '';
        let currentWalletNetwork = '';
        let currentUnsignedPSBT = '';
        let currentSignedPSBT = '';

        // Initialize on load
        window.addEventListener('load', function() {
            checkEnvironment();
            checkWalletAvailability();
            testBackendConnection();
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.currentTarget.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Check environment
        function checkEnvironment() {
            const protocol = window.location.protocol;
            const result = document.getElementById('environmentResult');
            
            if (protocol === 'file:') {
                result.innerHTML = '‚ùå WRONG PROTOCOL: file://\n‚úÖ REQUIRED: http:// or https://\n\nUse "Start Local Server" button.';
                result.className = 'result error';
            } else {
                result.innerHTML = '‚úÖ CORRECT PROTOCOL: ' + protocol + '\n‚úÖ Unisat Wallet should work.';
                result.className = 'result success';
            }
        }

        // Start local server instructions
        function startLocalServer() {
            const result = document.getElementById('environmentResult');
            result.innerHTML = 
                'üöÄ Starting Local Server:\n\n' +
                '1. Install http-server:\n' +
                '   npm install -g http-server\n\n' +
                '2. Run in your project folder:\n' +
                '   http-server -p 3000 --cors\n\n' +
                '3. Open: http://localhost:3000';
            result.className = 'result info';
        }

        // Check Unisat Wallet availability
        function checkWalletAvailability() {
            const walletStatus = document.getElementById('walletStatus');
            const connectBtn = document.getElementById('connectBtn');
            
            if (typeof window.unisat === 'undefined') {
                walletStatus.innerHTML = '‚ùå Unisat Wallet not detected. Install the extension.';
                walletStatus.className = 'status disconnected';
                connectBtn.disabled = true;
                return false;
            }

            // Check required methods
            const requiredMethods = ['requestAccounts', 'getAccounts', 'getNetwork', 'signPsbt'];
            const missingMethods = requiredMethods.filter(method => typeof window.unisat[method] !== 'function');
            
            if (missingMethods.length > 0) {
                walletStatus.innerHTML = '‚ö†Ô∏è Unisat detected but missing methods: ' + missingMethods.join(', ');
                walletStatus.className = 'status disconnected';
                connectBtn.disabled = true;
                return false;
            }

            walletStatus.innerHTML = '‚úÖ Unisat Wallet detected! Click "Connect" to proceed.';
            walletStatus.className = 'status info';
            connectBtn.disabled = false;
            return true;
        }

        // Connect to Unisat Wallet
        async function connectWallet() {
            try {
                const walletStatus = document.getElementById('walletStatus');
                walletStatus.innerHTML = 'üîÑ Connecting to Unisat Wallet...';
                
                const accounts = await window.unisat.requestAccounts();
                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found in Unisat Wallet');
                }
                
                currentWalletAddress = accounts[0];
                currentWalletNetwork = await window.unisat.getNetwork();
                
                // Check network
                checkNetworkCompatibility(currentWalletNetwork);
                
                isWalletConnected = true;
                document.getElementById('signBtn').disabled = false;
                document.getElementById('signSafeBtn').disabled = false;
                document.getElementById('infoBtn').disabled = false;
                
                walletStatus.innerHTML = `‚úÖ Connected!\nAddress: ${currentWalletAddress}\nNetwork: ${currentWalletNetwork}`;
                walletStatus.className = 'status connected';
                
                // Show wallet details
                document.getElementById('walletDetails').style.display = 'block';
                document.getElementById('walletInfo').innerHTML = `
                    <strong>Address:</strong> ${currentWalletAddress}<br>
                    <strong>Network:</strong> ${currentWalletNetwork}<br>
                    <strong>Status:</strong> Connected
                `;
                
                // Update form fields with wallet address
                updateFormFieldsWithAddress(currentWalletAddress);
                
            } catch (error) {
                const walletStatus = document.getElementById('walletStatus');
                walletStatus.innerHTML = `‚ùå Connection failed: ${error.message}`;
                walletStatus.className = 'status disconnected';
            }
        }

        // Check network compatibility
        function checkNetworkCompatibility(network) {
            const networkWarning = document.getElementById('networkWarning');
            if (network !== 'testnet') {
                document.getElementById('currentNetwork').textContent = network;
                networkWarning.style.display = 'block';
            } else {
                networkWarning.style.display = 'none';
            }
        }

        // Update form fields with wallet address
        function updateFormFieldsWithAddress(address) {
            // Update seller data
            try {
                const sellerData = JSON.parse(document.getElementById('sellerData').value);
                sellerData.seller_address = address;
                sellerData.payment_address = address;
                document.getElementById('sellerData').value = JSON.stringify(sellerData, null, 2);
            } catch (e) {}
            
            // Update buyer data
            try {
                const buyerData = JSON.parse(document.getElementById('buyerData').value);
                buyerData.buyer_payment_address = address;
                buyerData.buyer_receive_address = address;
                document.getElementById('buyerData').value = JSON.stringify(buyerData, null, 2);
            } catch (e) {}
            
            // Update dummy UTXO data
            try {
                const dummyData = JSON.parse(document.getElementById('dummyUtxoData').value);
                dummyData.payer_address = address;
                document.getElementById('dummyUtxoData').value = JSON.stringify(dummyData, null, 2);
            } catch (e) {}
            
            // Update verification address
            document.getElementById('verifyAddress').value = address;
            document.getElementById('analyzeAddress').value = address;
        }

        // Get wallet info
        async function getWalletInfo() {
            try {
                if (!isWalletConnected) throw new Error('Wallet not connected');
                
                const accounts = await window.unisat.getAccounts();
                const network = await window.unisat.getNetwork();
                const balance = await window.unisat.getBalance();
                
                const info = `üí∞ Wallet Information:\n\n` +
                    `üìç Address: ${accounts[0]}\n` +
                    `üåê Network: ${network}\n` +
                    `‚öñÔ∏è Balance: ${balance.total} sats\n` +
                    `üíé Confirmd: ${balance.confirmed} sats\n` +
                    `üîÑ Unconfirmed: ${balance.unconfirmed} sats`;
                
                showResult('walletDetails', info, 'success');
            } catch (error) {
                showResult('walletDetails', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Test backend connection
        async function testBackendConnection() {
            try {
                const backendUrl = document.getElementById('backendUrl').value;
                showResult('backendResult', 'üîÑ Testing backend connection...', 'info');

                const response = await fetch(`${backendUrl}/psbt/health`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const result = await response.json();
                document.getElementById('apiStatus').textContent = 'Healthy';
                document.getElementById('apiStatus').className = 'api-status healthy';
                
                showResult('backendResult', `‚úÖ Backend connected!\n\n${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'Unhealthy';
                document.getElementById('apiStatus').className = 'api-status unhealthy';
                showResult('backendResult', `‚ùå Backend connection failed: ${error.message}`, 'error');
            }
        }

        // Generic API call function
        async function callAPI(endpoint, data, resultElementId) {
            try {
                const backendUrl = document.getElementById('backendUrl').value;
                showResult(resultElementId, `üîÑ Calling ${endpoint}...`, 'info');

                const response = await fetch(`${backendUrl}/psbt/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    showResult(resultElementId, `‚úÖ ${endpoint} successful!\n\n${JSON.stringify(result, null, 2)}`, 'success');
                    return result;
                } else {
                    throw new Error(result.message || `API call failed for ${endpoint}`);
                }
            } catch (error) {
                showResult(resultElementId, `‚ùå ${endpoint} failed: ${error.message}`, 'error');
                return null;
            }
        }

        // Seller PSBT generation
        async function generateSellerPSBT(method) {
            try {
                const data = JSON.parse(document.getElementById('sellerData').value);
                const endpoint = method === 'simple' ? 'generate-seller-simple' : 'generate-seller';
                
                const result = await callAPI(endpoint, data, 'sellerGenerateResult');
                
                if (result && result.data && result.data.unsigned_psbt) {
                    currentUnsignedPSBT = result.data.unsigned_psbt;
                    document.getElementById('unsignedPSBT').value = currentUnsignedPSBT;
                }
            } catch (error) {
                showResult('sellerGenerateResult', `‚ùå Invalid JSON data: ${error.message}`, 'error');
            }
        }

        // Sign PSBT
// Enhanced signing function
async function signPSBT() {
    try {
        if (!isWalletConnected) throw new Error('Connect wallet first');
        
        const unsignedPSBT = document.getElementById('unsignedPSBT').value.trim();
        if (!unsignedPSBT) throw new Error('No PSBT to sign');

        showResult('sellerSignResult', 'üîÑ Signing PSBT for listing...', 'info');
        
        let signedPSBT;
        
        try {
            // First try standard signing
            signedPSBT = await window.unisat.signPsbt(unsignedPSBT);
        } catch (error) {
            console.log('Standard signing failed:', error.message);
            
            // If standard fails, try with explicit options
            try {
                signedPSBT = await window.unisat.signPsbt(unsignedPSBT, {
                    autoFinalized: false,
                    sighashTypes: ['SIGHASH_ALL']
                });
            } catch (secondError) {
                throw new Error(`Signing failed: ${secondError.message}. Make sure you own the inscription and have sufficient funds.`);
            }
        }
        
        currentSignedPSBT = signedPSBT;
        document.getElementById('signedPSBT').value = signedPSBT;
        
        showResult('sellerSignResult', 
            '‚úÖ PSBT signed successfully!\n\n' +
            'üí° The PSBT is now ready for listing creation.\n' +
            'Note: Some finalization warnings are normal for Taproot PSBTs.', 
            'success'
        );
        
    } catch (error) {
        showResult('sellerSignResult', 
            `‚ùå Signing failed: ${error.message}\n\n` +
            'üîß Troubleshooting:\n' +
            '‚Ä¢ Ensure you own the inscription\n' + 
            '‚Ä¢ Check wallet has funds for fees\n' +
            '‚Ä¢ Verify wallet is on testnet\n' +
            '‚Ä¢ Try generating a new PSBT', 
            'error'
        );
    }
}     // Safe mode signing
        async function signPSBTSafe() {
            try {
                if (!isWalletConnected) throw new Error('Connect wallet first');
                
                const unsignedPSBT = document.getElementById('unsignedPSBT').value.trim();
                if (!unsignedPSBT) throw new Error('No PSBT to sign');

                showResult('sellerSignResult', 'üîÑ Signing PSBT (Safe Mode)...', 'info');
                
                const signedPSBT = await window.unisat.signPsbt(unsignedPSBT, {
                    autoFinalized: false,
                    sighashTypes: ['SIGHASH_ALL']
                });
                
                currentSignedPSBT = signedPSBT;
                document.getElementById('signedPSBT').value = signedPSBT;
                
                showResult('sellerSignResult', '‚úÖ PSBT signed successfully (Safe Mode)!', 'success');
            } catch (error) {
                showResult('sellerSignResult', `‚ùå Safe signing failed: ${error.message}`, 'error');
            }
        }

        // Analyze PSBT
        async function analyzePSBT() {
            const psbt = document.getElementById('unsignedPSBT').value.trim();
            if (!psbt) {
                showResult('sellerSignResult', '‚ùå No PSBT to analyze', 'error');
                return;
            }

            const analysis = `üîç PSBT Analysis:\n\n` +
                `üì¶ Size: ${psbt.length} characters\n` +
                `üíæ Approx: ${Math.ceil(psbt.length * 0.75)} bytes\n` +
                `üìä Type: ${psbt.startsWith('c') ? 'Base64 PSBT' : 'Unknown format'}\n\n` +
                `üí° ${psbt.length > 1000 ? 'Large PSBT, consider simple method' : 'PSBT size looks good'}`;

            showResult('sellerSignResult', analysis, 'info');
        }

        // Create listing
        async function createListing() {
            try {
                const sellerData = JSON.parse(document.getElementById('sellerData').value);
                 const unsignedPSBT = document.getElementById('unsignedPSBT').value.trim();
                const signedPSBT = document.getElementById('signedPSBT').value.trim();
                
                if (!signedPSBT) throw new Error('No signed PSBT provided');

                const listingData = {
                    ...sellerData,
                    unsigned_psbt: unsignedPSBT,
                    signed_psbt: signedPSBT
                };

                await callAPI('create-listing', listingData, 'sellerListingResult');
            } catch (error) {
                showResult('sellerListingResult', `‚ùå Invalid data: ${error.message}`, 'error');
            }
        }

        // Verify signed PSBT
        async function verifySignedPSBT() {
            const signedPSBT = document.getElementById('signedPSBT').value.trim();
            if (!signedPSBT) {
                showResult('sellerListingResult', '‚ùå No signed PSBT to verify', 'error');
                return;
            }

            await callAPI('verify-signed-psbt', { signed_psbt: signedPSBT }, 'sellerListingResult');
        }

        // Buyer flow functions
        async function generateDummyUTXO() {
            try {
                const data = JSON.parse(document.getElementById('dummyUtxoData').value);
                await callAPI('generate-dummy-utxo', data, 'dummyUtxoResult');
            } catch (error) {
                showResult('dummyUtxoResult', `‚ùå Invalid JSON: ${error.message}`, 'error');
            }
        }

        async function generateBuyerPSBT() {
            try {
                const data = JSON.parse(document.getElementById('buyerData').value);
                await callAPI('generate-buyer', data, 'buyerGenerateResult');
            } catch (error) {
                showResult('buyerGenerateResult', `‚ùå Invalid JSON: ${error.message}`, 'error');
            }
        }

        async function signBuyerPSBT() {
            // Similar to seller signing but for buyer PSBT
            showResult('buyerBroadcastResult', 'üîÑ Use the Seller Flow tab to sign PSBTs', 'info');
        }

        async function broadcastTransaction() {
            const signedPSBT = document.getElementById('signedPSBT').value.trim();
            if (!signedPSBT) {
                showResult('buyerBroadcastResult', '‚ùå No signed PSBT to broadcast', 'error');
                return;
            }

            await callAPI('broadcast', { signed_psbt: signedPSBT }, 'buyerBroadcastResult');
        }

        // Utility functions
        async function verifyOwnership() {
            const data = {
                inscription_id: document.getElementById('verifyInscriptionId').value,
                address: document.getElementById('verifyAddress').value,
                network: 'testnet'
            };
            await callAPI('verify-ownership', data, 'utilitiesResult');
        }

        async function decodePSBTData() {
            const data = {
                encoded_data: document.getElementById('decodeData').value,
                network: 'testnet'
            };
            await callAPI('decode', data, 'utilitiesResult');
        }

        async function validatePSBT() {
            const data = {
                psbt_base64: document.getElementById('validatePSBTData').value,
                network: 'testnet'
            };
            await callAPI('validate', data, 'utilitiesResult');
        }

        async function analyzeAddress() {
            const data = {
                address: document.getElementById('analyzeAddress').value,
                network: 'testnet'
            };
            await callAPI('analyze-address', data, 'utilitiesResult');
        }

        // Debug functions
        async function runFullDiagnostics() {
            let diagnostics = 'üîß Running Full Diagnostics...\n\n';
            
            // Protocol check
            diagnostics += `1. Protocol: ${window.location.protocol} ${window.location.protocol === 'file:' ? '‚ùå' : '‚úÖ'}\n`;
            
            // Wallet check
            diagnostics += `2. Unisat Available: ${typeof window.unisat !== 'undefined' ? '‚úÖ' : '‚ùå'}\n`;
            
            // Backend check
            try {
                const backendUrl = document.getElementById('backendUrl').value;
                const response = await fetch(`${backendUrl}/psbt/health`);
                diagnostics += `3. Backend Connection: ${response.ok ? '‚úÖ' : '‚ùå'}\n`;
            } catch {
                diagnostics += `3. Backend Connection: ‚ùå\n`;
            }
            
            // Wallet connection
            diagnostics += `4. Wallet Connected: ${isWalletConnected ? '‚úÖ' : '‚ùå'}\n`;
            
            // Network check
            diagnostics += `5. Wallet Network: ${currentWalletNetwork} ${currentWalletNetwork === 'testnet' ? '‚úÖ' : '‚ùå'}\n`;
            
            showResult('debugResult', diagnostics, 'info');
        }

        async function testAllEndpoints() {
            showResult('debugResult', 'üß™ Testing all endpoints...', 'info');
            
            const endpoints = [
                'health',
                'generate-seller',
                'generate-buyer', 
                'verify-ownership',
                'decode'
            ];
            
            for (const endpoint of endpoints) {
                await testEndpoint(endpoint);
                await new Promise(resolve => setTimeout(resolve, 500)); // Delay between tests
            }
        }

        async function testEndpoint(endpoint) {
            const backendUrl = document.getElementById('backendUrl').value;
            let testData = {};
            
            // Add sample data for specific endpoints
            if (endpoint === 'generate-seller') {
                testData = JSON.parse(document.getElementById('sellerData').value);
            } else if (endpoint === 'generate-buyer') {
                testData = JSON.parse(document.getElementById('buyerData').value);
            } else if (endpoint === 'verify-ownership') {
                testData = {
                    inscription_id: 'samplei0',
                    address: currentWalletAddress || 'tb1q...',
                    network: 'testnet'
                };
            } else if (endpoint === 'decode') {
                testData = {
                    encoded_data: 'cHNidP8BAF4CAAAAAA==',
                    network: 'testnet'
                };
            }
            
            try {
                const response = await fetch(`${backendUrl}/psbt/${endpoint}`, {
                    method: endpoint === 'health' ? 'GET' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: endpoint === 'health' ? null : JSON.stringify(testData)
                });
                
                const result = await response.json();
                const status = response.ok ? '‚úÖ' : '‚ùå';
                
                const currentResult = document.getElementById('debugResult').textContent;
                document.getElementById('debugResult').textContent = 
                    currentResult + `\n${status} ${endpoint}: ${response.ok ? 'OK' : 'FAILED'}`;
                    
            } catch (error) {
                const currentResult = document.getElementById('debugResult').textContent;
                document.getElementById('debugResult').textContent = 
                    currentResult + `\n‚ùå ${endpoint}: ERROR - ${error.message}`;
            }
        }

        function showCommonFixes() {
            const fixes = `üîß Common Issues & Fixes:\n\n` +
                `‚ùå "Sighash type not allowed"\n` +
                `‚úÖ Use Simple PSBT generation or Safe Mode signing\n\n` +
                `‚ùå "User rejected request"\n` +
                `‚úÖ Click Sign in the Unisat popup\n\n` +
                `‚ùå CORS errors\n` +
                `‚úÖ Ensure backend has CORS enabled\n\n` +
                `‚ùå Wallet not detected\n` +
                `‚úÖ Use http://localhost, install Unisat extension\n\n` +
                `‚ùå Network mismatch\n` +
                `‚úÖ Switch Unisat to testnet`;
            
            showResult('debugResult', fixes, 'info');
        }

        // Helper function to show results
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        // Clear all fields
        function clearAll() {
            // Clear all textareas and results
            const elements = document.querySelectorAll('textarea, .result');
            elements.forEach(el => {
                if (el.className.includes('result')) {
                    el.textContent = '';
                } else {
                    el.value = '';
                }
            });
        }

        // Load sample data
        function loadSampleData() {
            // Sample data is already pre-loaded in the textareas
            showResult('debugResult', '‚úÖ Sample data loaded in all forms!', 'success');
        }
    </script>
</body>
</html>