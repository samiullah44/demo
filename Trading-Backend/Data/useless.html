<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordinal Marketplace PSBT Tester - Fixed</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f23; color: #fff; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; padding: 30px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; background: linear-gradient(to right, #4CAF50, #45a049); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #333; background: #1a1a2e; border-radius: 10px 10px 0 0; padding: 10px 10px 0 10px; }
        .tab { padding: 15px 28px; cursor: pointer; border: 2px solid transparent; margin-right: 8px; background: #252536; border-radius: 10px 10px 0 0; transition: all 0.3s; font-weight: 600; }
        .tab:hover { background: #2d2d44; transform: translateY(-2px); }
        .tab.active { border-color: #4CAF50; border-bottom-color: #1a1a2e; background: #2d2d44; box-shadow: 0 -2px 10px rgba(76, 175, 80, 0.3); }
        .tab-content { display: none; padding: 30px; background: #1a1a2e; border-radius: 0 15px 15px 15px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #ccc; font-weight: 600; font-size: 0.95em; }
        input, select, textarea { width: 100%; padding: 14px; background: #2d2d44; border: 2px solid #444; border-radius: 8px; color: #fff; font-size: 14px; transition: all 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #4CAF50; box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1); }
        textarea { height: 180px; font-family: 'Courier New', monospace; resize: vertical; line-height: 1.6; }
        button { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 14px 28px; border: none; border-radius: 8px; cursor: pointer; margin: 8px 8px 8px 0; font-size: 14px; font-weight: 700; transition: all 0.3s; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
        button:hover { background: linear-gradient(135deg, #45a049 0%, #4CAF50 100%); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); }
        button:active { transform: translateY(0); }
        button:disabled { background: #666; cursor: not-allowed; transform: none; box-shadow: none; }
        button.secondary { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3); }
        button.secondary:hover { background: linear-gradient(135deg, #1976D2 0%, #2196F3 100%); box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4); }
        button.danger { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3); }
        button.danger:hover { background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%); box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4); }
        button.warning { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3); }
        button.warning:hover { background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%); box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4); }
        .result { margin-top: 20px; padding: 20px; border-radius: 10px; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .success { border-left: 6px solid #4CAF50; background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); }
        .error { border-left: 6px solid #f44336; background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%); animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .info { border-left: 6px solid #2196F3; background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%); }
        .warning { border-left: 6px solid #ff9800; background: linear-gradient(135deg, #e65100 0%, #ef6c00 100%); }
        .status { padding: 18px; margin: 15px 0; border-radius: 10px; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .connected { background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: #a5d6a7; border-left: 6px solid #4CAF50; }
        .disconnected { background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%); color: #ffcdd2; border-left: 6px solid #f44336; }
        .step { background: linear-gradient(135deg, #252536 0%, #2d2d44 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; border-left: 6px solid #4CAF50; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .step-number { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: 700; font-size: 1.2em; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .endpoint-card { background: linear-gradient(135deg, #252536 0%, #2d2d44 100%); padding: 20px; border-radius: 12px; border: 2px solid #444; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .endpoint-card:hover { border-color: #4CAF50; transform: translateY(-5px); box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2); }
        .endpoint-card h4 { color: #4CAF50; margin-bottom: 15px; font-size: 1.2em; }
        .api-status { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; margin-left: 15px; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .api-status.healthy { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); animation: pulse 2s infinite; }
        .api-status.unhealthy { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .method-buttons { display: flex; gap: 12px; margin: 15px 0; flex-wrap: wrap; }
        .wallet-info { background: linear-gradient(135deg, #252536 0%, #2d2d44 100%); padding: 20px; border-radius: 12px; margin: 15px 0; border: 2px solid #4CAF50; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2); }
        .buyer-flow-buttons { display: flex; flex-wrap: wrap; gap: 12px; margin: 20px 0; }
        .buyer-flow-buttons button { flex: 1; min-width: 180px; }
        .psbt-preview { background: #1a1a2e; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #2196F3; font-family: 'Courier New', monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .signature-status { display: inline-block; padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: 700; margin-left: 8px; }
        .signature-status.signed { background: #4CAF50; color: white; }
        .signature-status.unsigned { background: #f44336; color: white; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #4CAF50; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Ordinal Marketplace PSBT Tester</h1>
            <p style="font-size: 1.1em; margin-top: 10px; color: #ccc;">Complete OpenOrdex-Compatible Testing Interface</p>
            <div style="margin-top: 15px;">
                <span style="font-weight: 600;">API Status: </span>
                <span id="apiStatus" class="api-status unhealthy">Checking...</span>
            </div>
        </div>

        <!-- Protocol Warning -->
        <div class="warning result" id="protocolWarning" style="display: none;">
            <strong>‚ö†Ô∏è Important:</strong> This page must be served via HTTP (not file://) for Unisat Wallet to work!
        </div>

        <!-- Network Warning -->
        <div class="warning result" id="networkWarning" style="display: none;">
            <strong>‚ö†Ô∏è Network Mismatch:</strong> Your wallet is on <span id="currentNetwork">mainnet</span> but this test requires <strong>testnet</strong>.
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('wallet')">üîó Wallet</div>
            <div class="tab" onclick="switchTab('seller')">üè∑Ô∏è Seller Flow</div>
            <div class="tab" onclick="switchTab('buyer')">üõí Buyer Flow</div>
            <div class="tab" onclick="switchTab('utilities')">üîß Utilities</div>
            <div class="tab" onclick="switchTab('debug')">üêõ Debug</div>
        </div>

        <!-- Wallet Tab -->
        <div id="wallet" class="tab-content active">
            <h2 style="margin-bottom: 25px; font-size: 1.8em;">üîó Wallet Connection & Setup</h2>
            
            <div class="step">
                <h3><span class="step-number">1</span> Check Environment</h3>
                <button onclick="checkEnvironment()" class="secondary">Check Environment</button>
                <div id="environmentResult" class="result" style="display: none;"></div>
            </div>

            <div class="step">
                <h3><span class="step-number">2</span> Connect Unisat Wallet</h3>
                <div id="walletStatus" class="status disconnected">
                    üîç Checking Unisat Wallet availability...
                </div>
                <button onclick="connectWallet()" id="connectBtn" disabled>Connect Unisat Wallet</button>
                <button onclick="getWalletInfo()" id="infoBtn" disabled class="secondary">Get Wallet Info</button>
                <button onclick="switchNetwork('testnet')" id="switchNetworkBtn" disabled class="warning">Switch to Testnet</button>
                
                <div id="walletDetails" class="wallet-info" style="display: none;">
                    <h4 style="margin-bottom: 15px; font-size: 1.3em;">üíé Wallet Details</h4>
                    <div id="walletInfo"></div>
                </div>
            </div>

            <div class="step">
                <h3><span class="step-number">3</span> Test Backend Connection</h3>
                <div class="form-group">
                    <label for="backendUrl">Backend API URL:</label>
                    <input type="text" id="backendUrl" value="http://localhost:5000/api">
                </div>
                <button onclick="testBackendConnection()" class="secondary">Test Backend Connection</button>
                <div id="backendResult" class="result" style="display: none;"></div>
            </div>
        </div>

        <!-- Seller Flow Tab -->
        <div id="seller" class="tab-content">
            <h2 style="margin-bottom: 25px; font-size: 1.8em;">üè∑Ô∏è Seller Flow - List Your Ordinal</h2>
            
            <div class="step">
                <h3><span class="step-number">1</span> Generate Seller PSBT (OpenOrdex Style)</h3>
                <div class="form-group">
                    <label for="sellerData">Seller PSBT Data (JSON):</label>
                    <textarea id="sellerData">{
  "inscription_id": "cda87f3f688dd825ec545aa2aeaeef3342b41d04da06adff56b82b3e7a91f96fi0",
  "inscription_number":"98691358"
  "inscription_output": "cda87f3f688dd825ec545aa2aeaeef3342b41d04da06adff56b82b3e7a91f96f:0",
  "price_sats": 6000,
  "seller_address": "",
  "payment_address": "",
  "network": "testnet"
}</textarea>
                </div>
                
                <button onclick="generateSellerPSBT()" class="primary">üîß Generate Seller PSBT</button>
                <button onclick="fillSellerAddress()" class="secondary">üìã Auto-Fill My Address</button>
                
                <div class="form-group">
                    <label for="unsignedPSBT">Generated Unsigned PSBT:</label>
                    <textarea id="unsignedPSBT" placeholder="Unsigned PSBT will appear here..."></textarea>
                </div>
                
                <div id="sellerGenerateResult" class="result" style="display: none;"></div>
            </div>

            <div class="step">
                <h3><span class="step-number">2</span> Sign PSBT with Wallet</h3>
                <button onclick="signPSBT()" id="signBtn" disabled>üîè Sign PSBT</button>
                <button onclick="analyzePSBT()" class="secondary">üîç Analyze PSBT</button>
                
                <div class="form-group">
                    <label for="signedPSBT">Signed PSBT:</label>
                    <textarea id="signedPSBT" placeholder="Signed PSBT will appear here..."></textarea>
                </div>
                
                <div id="sellerSignResult" class="result" style="display: none;"></div>
            </div>

            <div class="step">
                <h3><span class="step-number">3</span> Create Listing</h3>
                <button onclick="createListing()">üìù Create Listing</button>
                <button onclick="verifySignedPSBT()" class="secondary">‚úÖ Verify Signed PSBT</button>
                <div id="sellerListingResult" class="result" style="display: none;"></div>
            </div>
        </div>

        <!-- Buyer Flow Tab -->
        <div id="buyer" class="tab-content">
            <h2 style="margin-bottom: 25px; font-size: 1.8em;">üõí Buyer Flow - Purchase Ordinal</h2>
            
            <div class="step">
                <h3><span class="step-number">1</span> Generate Buyer PSBT</h3>
                <div class="form-group">
                    <label for="buyerData">Buyer PSBT Data (JSON):</label>
                    <textarea id="buyerData">{
  "listing_id": "",
  "buyer_payment_address": "",
  "buyer_receive_address": "",
  "fee_level": "hourFee",
  "network": "testnet"
}</textarea>
                </div>
                <button onclick="generateBuyerPSBT()">üîß Generate Buyer PSBT</button>
                <button onclick="fillBuyerAddress()" class="secondary">üìã Auto-Fill My Address</button>
                
                <div class="form-group">
                    <label for="buyerUnsignedPSBT">Generated Buyer Unsigned PSBT:</label>
                    <textarea id="buyerUnsignedPSBT" placeholder="Buyer unsigned PSBT will appear here..."></textarea>
                </div>
                
                <div id="buyerGenerateResult" class="result" style="display: none;"></div>
            </div>

            <div class="step">
                <h3><span class="step-number">2</span> Complete Purchase Flow</h3>
                 
    <div class="buyer-flow-buttons">
        <button onclick="signBuyerPSBT()">1. Sign Extended PSBT</button>
        <button onclick="verifyBuyerPSBT()">2. Verify Signatures</button>
        <button onclick="finalizeAndBroadcast()">3. Finalize & Broadcast</button>
    </div>
                
               <div class="form-group">
        <label for="buyerSignedPSBT">Buyer Signed PSBT (Extended):</label>
        <textarea id="buyerSignedPSBT" placeholder="Extended PSBT after signing will appear here..."></textarea>
    </div>
    
    <div id="buyerBroadcastResult" class="result" style="display: none;"></div>
            </div>
        </div>

        <!-- Utilities Tab -->
        <div id="utilities" class="tab-content">
            <h2 style="margin-bottom: 25px; font-size: 1.8em;">üîß Utility Endpoints</h2>
            
            <div class="grid">
                <div class="endpoint-card">
                    <h4>üîç Verify Ownership</h4>
                    <div class="form-group">
                        <label>Inscription ID:</label>
                        <input type="text" id="verifyInscriptionId" placeholder="abc123i0">
                    </div>
                    <div class="form-group">
                        <label>Address:</label>
                        <input type="text" id="verifyAddress" placeholder="tb1p...">
                    </div>
                    <button onclick="verifyOwnership()" class="secondary">Verify Ownership</button>
                </div>

                <div class="endpoint-card">
                    <h4>üéØ Analyze Address</h4>
                    <div class="form-group">
                        <label>Bitcoin Address:</label>
                        <input type="text" id="analyzeAddress" placeholder="tb1p...">
                    </div>
                    <button onclick="analyzeAddress()" class="secondary">Analyze Address</button>
                </div>
            </div>
            
            <div id="utilitiesResult" class="result" style="display: none;"></div>
        </div>

        <!-- Debug Tab -->
        <div id="debug" class="tab-content">
            <h2 style="margin-bottom: 25px; font-size: 1.8em;">üêõ Debug & Diagnostics</h2>
            
            <div class="step">
                <button onclick="runFullDiagnostics()" class="warning">üîß Run Full Diagnostics</button>
                <button onclick="showCommonFixes()" class="secondary">üí° Show Common Fixes</button>
                <button onclick="clearAll()" class="danger">üóëÔ∏è Clear All</button>
                <button onclick="loadSampleData()" class="secondary">üìù Load Sample Data</button>
            </div>

            <div id="debugResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Global variables
        let isWalletConnected = false;
        let currentWalletAddress = '';
        let currentWalletNetwork = '';

        // Initialize on load
        window.addEventListener('load', function() {
            checkEnvironment();
            checkWalletAvailability();
            testBackendConnection();
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.currentTarget.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Check environment
        function checkEnvironment() {
            const protocol = window.location.protocol;
            const result = document.getElementById('environmentResult');
            const warning = document.getElementById('protocolWarning');
            
            if (protocol === 'file:') {
                warning.style.display = 'block';
                result.innerHTML = '‚ùå WRONG PROTOCOL: file://\n‚úÖ REQUIRED: http:// or https://\n\nüí° Use a local server to test with Unisat Wallet.';
                result.className = 'result error';
                result.style.display = 'block';
            } else {
                warning.style.display = 'none';
                result.innerHTML = '‚úÖ CORRECT PROTOCOL: ' + protocol + '\n‚úÖ Unisat Wallet should work correctly.';
                result.className = 'result success';
                result.style.display = 'block';
            }
        }

        // Check Unisat Wallet availability
        function checkWalletAvailability() {
            const walletStatus = document.getElementById('walletStatus');
            const connectBtn = document.getElementById('connectBtn');
            
            if (typeof window.unisat === 'undefined') {
                walletStatus.innerHTML = '‚ùå Unisat Wallet not detected. Please install the extension.';
                walletStatus.className = 'status disconnected';
                connectBtn.disabled = true;
                return false;
            }

            const requiredMethods = ['requestAccounts', 'getAccounts', 'getNetwork', 'signPsbt'];
            const missingMethods = requiredMethods.filter(method => typeof window.unisat[method] !== 'function');
            
            if (missingMethods.length > 0) {
                walletStatus.innerHTML = '‚ö†Ô∏è Unisat detected but missing methods: ' + missingMethods.join(', ');
                walletStatus.className = 'status disconnected';
                connectBtn.disabled = true;
                return false;
            }

            walletStatus.innerHTML = '‚úÖ Unisat Wallet detected! Click "Connect" to proceed.';
            walletStatus.className = 'status info';
            connectBtn.disabled = false;
            return true;
        }

        // Connect to Unisat Wallet
        async function connectWallet() {
            try {
                const walletStatus = document.getElementById('walletStatus');
                walletStatus.innerHTML = 'üîÑ Connecting to Unisat Wallet...<span class="loading-spinner"></span>';
                
                const accounts = await window.unisat.requestAccounts();
                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found in Unisat Wallet');
                }
                
                currentWalletAddress = accounts[0];
                currentWalletNetwork = await window.unisat.getNetwork();
                
                checkNetworkCompatibility(currentWalletNetwork);
                
                isWalletConnected = true;
                document.getElementById('signBtn').disabled = false;
                document.getElementById('infoBtn').disabled = false;
                document.getElementById('switchNetworkBtn').disabled = false;
                document.getElementById('signBuyerBtn').disabled = false;
                
                walletStatus.innerHTML = `‚úÖ Connected Successfully!\nAddress: ${currentWalletAddress}\nNetwork: ${currentWalletNetwork}`;
                walletStatus.className = 'status connected';
                
                document.getElementById('walletDetails').style.display = 'block';
                document.getElementById('walletInfo').innerHTML = `
                    <strong>Address:</strong> ${currentWalletAddress}<br>
                    <strong>Network:</strong> <span style="color: ${currentWalletNetwork === 'testnet' ? '#4CAF50' : '#f44336'}">${currentWalletNetwork}</span><br>
                    <strong>Status:</strong> <span style="color: #4CAF50">Connected</span>
                `;
                
                updateFormFieldsWithAddress(currentWalletAddress);
                
            } catch (error) {
                const walletStatus = document.getElementById('walletStatus');
                walletStatus.innerHTML = `‚ùå Connection failed: ${error.message}`;
                walletStatus.className = 'status disconnected';
            }
        }

        // Switch network
        async function switchNetwork(network) {
            try {
                await window.unisat.switchNetwork(network);
                showResult('walletDetails', `‚úÖ Switched to ${network}`, 'success');
                
                // Reconnect to update network info
                setTimeout(() => connectWallet(), 500);
            } catch (error) {
                showResult('walletDetails', `‚ùå Network switch failed: ${error.message}`, 'error');
            }
        }

        // Check network compatibility
        function checkNetworkCompatibility(network) {
            const networkWarning = document.getElementById('networkWarning');
            if (network !== 'testnet') {
                document.getElementById('currentNetwork').textContent = network;
                networkWarning.style.display = 'block';
            } else {
                networkWarning.style.display = 'none';
            }
        }

        // Update form fields with wallet address
        function updateFormFieldsWithAddress(address) {
            try {
                const sellerData = JSON.parse(document.getElementById('sellerData').value);
                sellerData.seller_address = address;
                sellerData.payment_address = address;
                document.getElementById('sellerData').value = JSON.stringify(sellerData, null, 2);
            } catch (e) {}
            
            try {
                const buyerData = JSON.parse(document.getElementById('buyerData').value);
                buyerData.buyer_payment_address = address;
                buyerData.buyer_receive_address = address;
                document.getElementById('buyerData').value = JSON.stringify(buyerData, null, 2);
            } catch (e) {}
            
            document.getElementById('verifyAddress').value = address;
            document.getElementById('analyzeAddress').value = address;
        }

        // Fill seller address
        function fillSellerAddress() {
            if (!isWalletConnected) {
                showResult('sellerGenerateResult', '‚ùå Connect wallet first', 'error');
                return;
            }
            updateFormFieldsWithAddress(currentWalletAddress);
            showResult('sellerGenerateResult', '‚úÖ Address filled from wallet', 'success');
        }

        // Fill buyer address
        function fillBuyerAddress() {
            if (!isWalletConnected) {
                showResult('buyerGenerateResult', '‚ùå Connect wallet first', 'error');
                return;
            }
            updateFormFieldsWithAddress(currentWalletAddress);
            showResult('buyerGenerateResult', '‚úÖ Address filled from wallet', 'success');
        }

        // Get wallet info
        async function getWalletInfo() {
            try {
                if (!isWalletConnected) throw new Error('Wallet not connected');
                
                const accounts = await window.unisat.getAccounts();
                const network = await window.unisat.getNetwork();
                const balance = await window.unisat.getBalance();
                
                const info = `üí∞ Wallet Information:\n\n` +
                    `üìç Address: ${accounts[0]}\n` +
                    `üåê Network: ${network}\n` +
                    `‚öñÔ∏è Balance: ${balance.total.toLocaleString()} sats\n` +
                    `üíé Confirmed: ${balance.confirmed.toLocaleString()} sats\n` +
                    `üîÑ Unconfirmed: ${balance.unconfirmed.toLocaleString()} sats`;
                
                showResult('walletDetails', info, 'success');
            } catch (error) {
                showResult('walletDetails', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Test backend connection
        async function testBackendConnection() {
            try {
                const backendUrl = document.getElementById('backendUrl').value;
                showResult('backendResult', 'üîÑ Testing backend connection...<span class="loading-spinner"></span>', 'info');

                const response = await fetch(`${backendUrl}/psbt/health`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const result = await response.json();
                document.getElementById('apiStatus').textContent = 'Healthy';
                document.getElementById('apiStatus').className = 'api-status healthy';
                
                showResult('backendResult', `‚úÖ Backend connected successfully!\n\n${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'Unhealthy';
                document.getElementById('apiStatus').className = 'api-status unhealthy';
                showResult('backendResult', `‚ùå Backend connection failed: ${error.message}`, 'error');
            }
        }

        // Generic API call function
        async function callAPI(endpoint, data, resultElementId) {
            try {
                const backendUrl = document.getElementById('backendUrl').value;
                showResult(resultElementId, `üîÑ Calling ${endpoint}...<span class="loading-spinner"></span>`, 'info');

                const response = await fetch(`${backendUrl}/psbt/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    showResult(resultElementId, `‚úÖ ${endpoint} successful!\n\n${JSON.stringify(result, null, 2)}`, 'success');
                    return result;
                } else {
                    throw new Error(result.message || `API call failed for ${endpoint}`);
                }
            } catch (error) {
                showResult(resultElementId, `‚ùå ${endpoint} failed:\n${error.message}`, 'error');
                return null;
            }
        }

        // Generate Seller PSBT
        async function generateSellerPSBT() {
            try {
                const data = JSON.parse(document.getElementById('sellerData').value);
                
                const result = await callAPI('generate-seller', data, 'sellerGenerateResult');
                
                if (result && result.data && result.data.unsigned_psbt) {
                    document.getElementById('unsignedPSBT').value = result.data.unsigned_psbt;
                }
            } catch (error) {
                showResult('sellerGenerateResult', `‚ùå Invalid JSON data: ${error.message}`, 'error');
            }
        }

        // Sign PSBT
        async function signPSBT() {
            try {
                if (!isWalletConnected) throw new Error('Connect wallet first');
                
                const unsignedPSBT = document.getElementById('unsignedPSBT').value.trim();
                if (!unsignedPSBT) throw new Error('No PSBT to sign');
                

                showResult('sellerSignResult', 'üîÑ Signing PSBT...<span class="loading-spinner"></span>', 'info');
                
                const signedPSBT = await window.unisat.signPsbt(unsignedPSBT, {
                    autoFinalized: false
                });
                
                document.getElementById('signedPSBT').value = signedPSBT;
                
                showResult('sellerSignResult', 
                    '‚úÖ PSBT signed successfully!\n\n' +
                    'üí° The PSBT is now ready for listing creation.\n' +
                    'üìù Proceed to Step 3 to create the listing.', 
                    'success'
                );
                
            } catch (error) {
                showResult('sellerSignResult', 
                    `‚ùå Signing failed: ${error.message}\n\n` +
                    'üîß Troubleshooting:\n' +
                    '‚Ä¢ Ensure you own the inscription\n' + 
                    '‚Ä¢ Check wallet has funds for fees\n' +
                    '‚Ä¢ Verify wallet is on testnet\n' +
                    '‚Ä¢ Try generating a new PSBT', 
                    'error'
                );
            }
        }

        // Analyze PSBT
        async function analyzePSBT() {
            const psbt = document.getElementById('unsignedPSBT').value.trim();
            if (!psbt) {
                showResult('sellerSignResult', '‚ùå No PSBT to analyze', 'error');
                return;
            }

            const analysis = `üîç PSBT Analysis:\n\n` +
                `üì¶ Size: ${psbt.length} characters\n` +
                `üíæ Approx Bytes: ${Math.ceil(psbt.length * 0.75)}\n` +
                `üìä Format: ${psbt.startsWith('c') ? 'Base64 PSBT ‚úÖ' : 'Unknown format ‚ùå'}\n` +
                `üîê Compatible: ${psbt.length < 5000 ? 'Yes ‚úÖ' : 'Large PSBT ‚ö†Ô∏è'}\n\n` +
                `üí° Status: ${psbt.length > 1000 ? 'PSBT looks valid' : 'PSBT might be incomplete'}`;

            showResult('sellerSignResult', analysis, 'info');
        }

        // Create listing
        async function createListing() {
            try {
                const sellerData = JSON.parse(document.getElementById('sellerData').value);
                const unsignedPSBT = document.getElementById('unsignedPSBT').value.trim();
                const signedPSBT = document.getElementById('signedPSBT').value.trim();
                
                if (!signedPSBT) throw new Error('No signed PSBT provided. Sign the PSBT first.');

                const listingData = {
                    ...sellerData,
                    unsigned_psbt: unsignedPSBT,
                    signed_psbt: signedPSBT
                };

                await callAPI('create-listing', listingData, 'sellerListingResult');
            } catch (error) {
                showResult('sellerListingResult', `‚ùå Invalid data: ${error.message}`, 'error');
            }
        }

        // Verify signed PSBT
        async function verifySignedPSBT() {
            const signedPSBT = document.getElementById('signedPSBT').value.trim();
            if (!signedPSBT) {
                showResult('sellerListingResult', '‚ùå No signed PSBT to verify', 'error');
                return;
            }

            await callAPI('verify-signed-psbt', { signed_psbt: signedPSBT, network: 'testnet' }, 'sellerListingResult');
        }
let buyer_metadata;
async function generateBuyerPSBT() {
    try {
        const data = JSON.parse(document.getElementById('buyerData').value);
        
        console.log("üîÑ Generating Buyer PSBT...");
        console.log("üì§ Sending data:", data);
        
        // Store buyer metadata for later use
        const result = await callAPI('generate-buyer', data, 'buyerGenerateResult');
        
        console.log("üì• Backend response:", result);
        
        if (result && result.data) {
            // DEBUG: Check the exact structure of the response
            console.log("üîç Response data structure:", Object.keys(result.data));
            console.log("üì¶ PSBT field exists:", 'psbt' in result.data);
            console.log("üìã Metadata exists:", 'metadata' in result.data);
            
            // Store metadata globally for finalization
            window.buyerMetadata = result.data.metadata;
            window.listingData = result.data.listing;
            
            // FIXED: Handle different possible field names for PSBT
            let psbtData = '';
            
            if (result.data.psbt) {
                psbtData = result.data.psbt;
                console.log("‚úÖ Using 'psbt' field");
            } else if (result.data.unsigned_psbt) {
                psbtData = result.data.unsigned_psbt;
                console.log("‚úÖ Using 'unsigned_psbt' field");
            } else if (result.data.buyer_psbt) {
                psbtData = result.data.buyer_psbt;
                console.log("‚úÖ Using 'buyer_psbt' field");
            } else {
                // Try to find any field that might contain PSBT data
                const possibleFields = Object.keys(result.data).filter(key => 
                    typeof result.data[key] === 'string' && 
                    (result.data[key].includes('cHNid') || result.data[key].length > 100)
                );
                
                if (possibleFields.length > 0) {
                    psbtData = result.data[possibleFields[0]];
                    console.log(`‚úÖ Using '${possibleFields[0]}' field for PSBT`);
                } else {
                    throw new Error('No PSBT data found in response. Available fields: ' + Object.keys(result.data).join(', '));
                }
            }
            
            // Set the PSBT in the textarea
            document.getElementById('buyerUnsignedPSBT').value = psbtData;
            document.getElementById('buyerSignedPSBT').value = '';
            
            console.log("üìè PSBT length:", psbtData.length);
            console.log("üîç PSBT preview:", psbtData.substring(0, 50) + '...');
            
            // Extract signing instructions from metadata
            const inputsToSign = window.buyerMetadata?.inputsToSign || [];
            const inputsToSkip = window.buyerMetadata?.inputsToSkip || [];
            
            // Build structure display
            let structureInfo = '';
            if (window.buyerMetadata?.structure) {
                structureInfo = `üìä Transaction Structure:\n`;
                
                // Inputs
                structureInfo += `‚Ä¢ Inputs:\n`;
                window.buyerMetadata.structure.inputs.forEach(input => {
                    const signStatus = input.sign === false ? '‚ùå (skip)' : '‚úÖ (sign)';
                    structureInfo += `  ${input.index}: ${input.type} - ${input.value} sats ${signStatus}\n`;
                });
                
                // Outputs  
                structureInfo += `‚Ä¢ Outputs:\n`;
                window.buyerMetadata.structure.outputs.forEach(output => {
                    structureInfo += `  ${output.index}: ${output.type} ‚Üí ${output.address.substring(0, 15)}... - ${output.value} sats\n`;
                });
            }
            
            // Update UI to show OpenOrdex flow
            showResult('buyerGenerateResult', 
                `‚úÖ OpenOrdex Buyer PSBT Generated!\n\n` +
                `üí∞ Price: ${window.buyerMetadata?.priceSats || 'N/A'} sats\n` +
                `‚õΩ Fee Rate: ${window.buyerMetadata?.feeRate || 'N/A'} sat/vB\n` +
                `üíé Ordinal Value: ${window.buyerMetadata?.ordinalValue || 'N/A'} sats\n` +
                `üì¶ PSBT Size: ${psbtData.length} characters\n\n` +
                `${structureInfo}\n` +
                `üîê SIGNING INSTRUCTIONS:\n` +
                `‚Ä¢ ‚úÖ Sign Inputs: [${inputsToSign.join(', ')}] (Your dummy + payment UTXOs)\n` +
                `‚Ä¢ ‚ùå Skip Input: [${inputsToSkip.join(', ')}] (Seller's ordinal - already signed)\n\n` +
                `üí° Important: Only sign the specified inputs to avoid invalidating seller's signature!`,
                'success'
            );
            
            // Also update the UI to show the PSBT was received
            const textarea = document.getElementById('buyerUnsignedPSBT');
            if (textarea.value.trim().length > 0) {
                textarea.style.borderColor = '#28a745';
                textarea.style.backgroundColor = '#f8fff9';
            }
            
        } else {
            throw new Error('Invalid response structure from server');
        }
    } catch (error) {
        console.error("‚ùå Buyer PSBT generation failed:", error);
        showResult('buyerGenerateResult', 
            `‚ùå Failed to generate buyer PSBT: ${error.message}\n\n` +
            'üîß Troubleshooting:\n' +
            '‚Ä¢ Check backend response structure\n' +
            '‚Ä¢ Verify the API endpoint returns PSBT data\n' +
            '‚Ä¢ Ensure seller PSBT is properly signed\n' +
            '‚Ä¢ Confirm network connectivity',
            'error'
        );
        
        // Clear fields on error
        document.getElementById('buyerUnsignedPSBT').value = '';
        document.getElementById('buyerSignedPSBT').value = '';
    }
}
// UPDATED: Sign Buyer PSBT with Proper Input Selection
async function signBuyerPSBT() {
    try {
        const buyerUnsignedPSBT = document.getElementById('buyerUnsignedPSBT').value.trim();
        if (!buyerUnsignedPSBT) {
            throw new Error('Generate buyer PSBT first');
        }

        if (!isWalletConnected) {
            throw new Error('Connect wallet first');
        }

        if (!window.buyerMetadata) {
            throw new Error('Buyer metadata not found. Generate buyer PSBT first.');
        }

        // Get the buyer's payment address for signing
        const buyerPaymentAddress = window.buyerMetadata.buyerPaymentAddress;
        if (!buyerPaymentAddress) {
            throw new Error('Buyer payment address not found in metadata');
        }

        // Determine which inputs to sign based on OpenOrdex structure
        // Input 0: Dummy UTXO (buyer signs)
        // Input 1: Seller ordinal (DO NOT SIGN - already signed)
        // Input 2+: Payment UTXOs (buyer signs)
        const inputsToSign = [];
        
        if (window.buyerMetadata.structure && window.buyerMetadata.structure.inputs) {
            window.buyerMetadata.structure.inputs.forEach(input => {
                if (input.type === 'dummy' || input.type === 'payment') {
                    inputsToSign.push(input.index);
                }
            });
        } else {
            // Fallback: sign all inputs except index 1 (seller's ordinal)
            // This assumes the OpenOrdex structure: 0=dummy, 1=ordinal, 2+=payment
            inputsToSign.push(0); // Always sign dummy input
            // Add payment inputs (assuming we have at least 3 inputs total)
            if (window.buyerMetadata.totalInputs > 2) {
                for (let i = 2; i < window.buyerMetadata.totalInputs; i++) {
                    inputsToSign.push(i);
                }
            }
        }

        showResult('buyerBroadcastResult', 
            `üîÑ Signing Buyer PSBT (OpenOrdex Pattern)...<span class="loading-spinner"></span>\n\n` +
            `üìã Signing Instructions:\n` +
            `‚Ä¢ ‚úÖ Signing Inputs: [${inputsToSign.join(', ')}]\n` +
            `‚Ä¢ ‚ùå Skipping Input: [1] (Seller's ordinal - pre-signed)\n` +
            `‚Ä¢ üîê Using Address: ${buyerPaymentAddress}\n\n` +
            `üí° Make sure your wallet only signs the specified inputs!`,
            'info'
        );

        console.log('üîê Signing configuration:', {
            inputsToSign,
            buyerPaymentAddress,
            totalInputs: window.buyerMetadata.totalInputs,
            structure: window.buyerMetadata.structure
        });

        // Sign ONLY the specified inputs using Unisat's signInputs option
        const signOptions = {
            autoFinalized: false,
            signInputs: {
                [buyerPaymentAddress]: inputsToSign
            }
        };

        console.log('üì§ Sending signing request to Unisat...', signOptions);
        
        // Sign the PSBT with specific inputs
        const signedPSBT = await window.unisat.signPsbt(buyerUnsignedPSBT, signOptions);

        document.getElementById('buyerSignedPSBT').value = signedPSBT;

        showResult('buyerBroadcastResult', 
            '‚úÖ PSBT Signed Successfully!\n\n' +
            'üìä OpenOrdex Structure Applied:\n' +
            '‚Ä¢ Input 0: Your dummy UTXO ‚úÖ (signed by you)\n' +
            '‚Ä¢ Input 1: Seller\'s ordinal ‚úÖ (pre-signed, preserved)\n' +
            '‚Ä¢ Inputs 2+: Your payment UTXOs ‚úÖ (signed by you)\n' +
            '‚Ä¢ Output 0: Ordinal ‚Üí Your address\n' +
            '‚Ä¢ Output 1: Payment ‚Üí Seller\n\n' +
            'üöÄ Ready to finalize and broadcast!',
            'success'
        );

        console.log('‚úÖ PSBT signed successfully, ready for finalization');

    } catch (error) {
        console.error('‚ùå Signing failed:', error);
        showResult('buyerBroadcastResult', 
            `‚ùå Signing failed: ${error.message}\n\n` +
            'üîß OpenOrdex Troubleshooting:\n' +
            '‚Ä¢ Ensure you are only signing inputs [0, 2+] (skip input 1)\n' +
            '‚Ä¢ Verify your wallet controls the payment address\n' +
            '‚Ä¢ Check that seller signature is preserved\n' +
            '‚Ä¢ Confirm PSBT follows OpenOrdex structure',
            'error'
        );
    }
}

// UPDATED: Finalize and Broadcast with Enhanced Error Handling
async function finalizeAndBroadcast() {
    try {
        const buyerSignedPSBT = document.getElementById('buyerSignedPSBT').value.trim();
        if (!buyerSignedPSBT) {
            throw new Error('Sign the buyer PSBT first');
        }

        if (!window.buyerMetadata) {
            throw new Error('Buyer metadata not found. Generate buyer PSBT first.');
        }

        showResult('buyerBroadcastResult', 
            'üîß Finalizing and broadcasting...<span class="loading-spinner"></span>\n\n' +
            'üí° Finalizing all inputs and extracting transaction...',
            'info'
        );

        console.log('üì§ Sending signed PSBT for finalization and broadcast...');

        // Call the broadcast endpoint
        const result = await callAPI('broadcast', {
            psbt: buyerSignedPSBT, // Changed from buyer_extended_psbt to match backend
            network: window.buyerMetadata.network || 'testnet'
        }, 'buyerBroadcastResult');

        if (result && result.data) {
            showResult('buyerBroadcastResult', 
                'üéâ Transaction Finalized & Broadcast Successfully!\n\n' +
                `üìä OpenOrdex Flow Complete\n` +
                `üÜî TXID: ${result.data.txid}\n` +
                `üîó Explorer: ${result.data.explorer_url}\n` +
                `üí∞ Price: ${window.buyerMetadata.priceSats} sats\n` +
                `üéØ Ordinal destination: ${window.buyerMetadata.buyerReceiveAddress}\n\n` +
                `‚è≥ Waiting for confirmation...`,
                'success'
            );
            
            // Clear the form for next transaction
            setTimeout(() => {
                document.getElementById('buyerUnsignedPSBT').value = '';
                document.getElementById('buyerSignedPSBT').value = '';
                window.buyerMetadata = null;
            }, 5000);
        }

    } catch (error) {
        console.error('‚ùå Finalization failed:', error);
        showResult('buyerBroadcastResult', 
            `‚ùå Finalization failed: ${error.message}\n\n` +
            'üîß Common Solutions:\n' +
            '‚Ä¢ Verify seller PSBT uses SIGHASH_SINGLE|ANYONECANPAY\n' +
            '‚Ä¢ Check buyer only signed inputs [0, 2+] (not input 1)\n' +
            '‚Ä¢ Ensure sufficient fee coverage\n' +
            '‚Ä¢ Confirm all required inputs are signed\n' +
            '‚Ä¢ Verify network compatibility (testnet/mainnet)',
            'error'
        );
    }
}

// NEW: Helper function to display PSBT structure
function displayPSBTStructure(metadata) {
    if (!metadata.structure) return '';
    
    const structure = metadata.structure;
    let display = 'üìä PSBT Structure:\n';
    
    // Inputs
    display += '‚Ä¢ Inputs:\n';
    structure.inputs.forEach(input => {
        const signStatus = input.type === 'ordinal' ? '‚ùå (seller signed)' : '‚úÖ (you sign)';
        display += `  ${input.index}: ${input.type} - ${input.value} sats ${signStatus}\n`;
    });
    
    // Outputs  
    display += '‚Ä¢ Outputs:\n';
    structure.outputs.forEach(output => {
        display += `  ${output.index}: ${output.type} ‚Üí ${output.address} - ${output.value} sats\n`;
    });
    
    return display;
}
// UPDATED: Verify Buyer PSBT for OpenOrdex structure
async function verifyBuyerPSBT() {
    try {
        const signedPSBT = document.getElementById('buyerSignedPSBT').value.trim();
        if (!signedPSBT) {
            throw new Error('No signed PSBT to verify');
        }

        if (!window.buyerMetadata) {
            throw new Error('Buyer metadata not found');
        }

        showResult('buyerBroadcastResult', 'üîç Verifying OpenOrdex PSBT structure...', 'info');

        // For now, do a basic client-side check
        const analysis = `üîç OpenOrdex PSBT Analysis:\n\n` +
            `üì¶ PSBT Size: ${signedPSBT.length} characters\n` +
            `üíæ Format: ${signedPSBT.startsWith('c') ? 'Base64 ‚úÖ' : 'Unknown ‚ùå'}\n` +
            `üîê Signed Status: ${signedPSBT.length > 1000 ? 'Likely Signed ‚úÖ' : 'Possibly Unsigned ‚ö†Ô∏è'}\n\n` +
            `üìä Expected Structure:\n` +
            `   ‚Ä¢ Multiple inputs (seller + buyer)\n` +
            `   ‚Ä¢ Multiple outputs (ordinal, payment, change)\n` +
            `   ‚Ä¢ Seller signature preserved\n` +
            `   ‚Ä¢ Buyer signatures on payment inputs\n\n` +
            `üí° Next: Finalize & Broadcast to complete purchase`;

        showResult('buyerBroadcastResult', analysis, 'info');

    } catch (error) {
        showResult('buyerBroadcastResult', `‚ùå Verification failed: ${error.message}`, 'error');
    }
}
        // Broadcast Buyer Transaction
        async function broadcastBuyerTransaction() {
            try {
                const signedPSBT = document.getElementById('buyerSignedPSBT').value.trim();
                if (!signedPSBT) {
                    throw new Error('No signed PSBT to broadcast. Sign and verify the PSBT first.');
                }

                const buyerData = JSON.parse(document.getElementById('buyerData').value);
                const network = buyerData.network || 'testnet';

                showResult('buyerBroadcastResult', 'üì° Broadcasting transaction...<span class="loading-spinner"></span>', 'info');

                const result = await callAPI('broadcast', { 
                    signed_psbt: signedPSBT,
                    network: network
                }, 'buyerBroadcastResult');

                if (result && result.data) {
                    showResult('buyerBroadcastResult', 
                        'üéâ Transaction broadcast successfully!\n\n' +
                        `Transaction ID: ${result.data.txid}\n` +
                        `Network: ${result.data.network}\n` +
                        `Explorer: ${result.data.explorer_url || 'N/A'}\n\n` +
                        '‚úÖ Your ordinal purchase is being processed!', 
                        'success'
                    );
                }

            } catch (error) {
                showResult('buyerBroadcastResult', 
                    `‚ùå Broadcast failed: ${error.message}\n\n` +
                    'üîß Troubleshooting:\n' +
                    '‚Ä¢ Check if PSBT is fully signed\n' +
                    '‚Ä¢ Verify network compatibility\n' +
                    '‚Ä¢ Ensure sufficient fee coverage\n' +
                    '‚Ä¢ Check if UTXOs are still unspent', 
                    'error'
                );
            }
        }

        // Utility functions
        async function verifyOwnership() {
            const data = {
                inscription_id: document.getElementById('verifyInscriptionId').value,
                address: document.getElementById('verifyAddress').value,
                network: 'testnet'
            };
            await callAPI('verify-ownership', data, 'utilitiesResult');
        }

        async function analyzeAddress() {
            const data = {
                address: document.getElementById('analyzeAddress').value,
                network: 'testnet'
            };
            await callAPI('analyze-address', data, 'utilitiesResult');
        }

        // Debug functions
        async function runFullDiagnostics() {
            let diagnostics = 'üîß Running Full Diagnostics...\n\n';
            
            diagnostics += `1. Protocol: ${window.location.protocol} ${window.location.protocol === 'file:' ? '‚ùå' : '‚úÖ'}\n`;
            diagnostics += `2. Unisat Available: ${typeof window.unisat !== 'undefined' ? '‚úÖ' : '‚ùå'}\n`;
            
            try {
                const backendUrl = document.getElementById('backendUrl').value;
                const response = await fetch(`${backendUrl}/psbt/health`);
                diagnostics += `3. Backend Connection: ${response.ok ? '‚úÖ' : '‚ùå'}\n`;
            } catch {
                diagnostics += `3. Backend Connection: ‚ùå\n`;
            }
            
            diagnostics += `4. Wallet Connected: ${isWalletConnected ? '‚úÖ' : '‚ùå'}\n`;
            diagnostics += `5. Wallet Network: ${currentWalletNetwork} ${currentWalletNetwork === 'testnet' ? '‚úÖ' : '‚ùå'}\n`;
            
            showResult('debugResult', diagnostics, 'info');
        }

        function showCommonFixes() {
            const fixes = `üîß Common Issues & Fixes:\n\n` +
                `‚ùå "Invalid Schnorr signature"\n` +
                `‚úÖ Regenerate PSBTs and re-sign with wallet\n` +
                `‚úÖ Ensure using OpenOrdex-compatible structure\n\n` +
                `‚ùå "Can't modify signature"\n` +
                `‚úÖ This is fixed in the new code - seller signatures are copied, not modified\n\n` +
                `‚ùå "User rejected request"\n` +
                `‚úÖ Click Sign in the Unisat popup\n\n` +
                `‚ùå "Missing or spent UTXO"\n` +
                `‚úÖ Generate new buyer PSBT with fresh UTXOs\n\n` +
                `‚ùå "No address or publickey to sign"\n` +
                `‚úÖ Ensure witnessUtxo is properly formatted in PSBT\n\n` +
                `‚ùå Network mismatch\n` +
                `‚úÖ Switch Unisat to testnet using the button`;
            
            showResult('debugResult', fixes, 'info');
        }

        // Helper function to show results
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // Clear all fields
        function clearAll() {
            const elements = document.querySelectorAll('textarea, .result');
            elements.forEach(el => {
                if (el.className.includes('result')) {
                    el.innerHTML = '';
                    el.style.display = 'none';
                } else {
                    el.value = '';
                }
            });
            showResult('debugResult', '‚úÖ All fields cleared!', 'success');
        }

        // Load sample data
        function loadSampleData() {
            showResult('debugResult', '‚úÖ Sample data is pre-loaded in all forms!', 'success');
        }
    </script>
</body>
</html>

<!-- 192,530 sats
üíé Confirmed: 192,530 sats -->